# PicHub - 需求规格说明书

## 1. 项目概述

### 1.1 背景与目标
实现一个图片管理网站，用于课程大作业验收：支持注册登录、图片上传存储、EXIF 信息提取与辅助信息、标签与检索、缩略图、轮播展示、基础编辑、删除、移动端适配，并包含 AI 标签与自然语言检索增强功能。

### 1.2 技术栈
- 前端：Vue 3 + Vite + Vue Router + Pinia + Element Plus + Tailwind CSS
- 后端：Node.js（ESM）+ Express + Sequelize
- 数据库：MySQL 8（测试使用 SQLite）
- 文件处理：multer + sharp + exif-parser
- AI：Google Gemini（可选）
- 地图：高德 AMap 逆地理（可选）
- 部署：Docker + Docker Compose

---

## 2. 角色与术语

### 2.1 角色
- 访客：未登录用户（只能注册/登录）
- 登录用户：拥有独立的数据空间，可管理自己的图片/标签/轮播列表

### 2.2 术语
- EXIF：照片元数据（拍摄时间、GPS、设备参数等）
- 标签类型：`custom`（用户自定义）、`ai`（AI 生成）、`auto`（系统自动生成）
- NL Search：自然语言搜索（Natural Language Search）

---

## 3. 功能需求

### 3.1 用户注册/登录（基本功能 1）
- 注册时需填写用户名、邮箱、密码
- 校验规则：
  - 用户名长度 ≥ 6
  - 密码长度 ≥ 6
  - email 格式校验，且用户名/email 全局唯一
- 登录后获取 JWT，并用于后续所有 API

### 3.2 上传与存储（基本功能 2）
- 支持 PC/手机浏览器上传图片
- 支持多文件上传
- 上传后图片文件落盘到 `UPLOADS_DIR`（容器中为 volume）

### 3.3 EXIF 与辅助信息（基本功能 3）
系统在上传/编辑保存副本时尝试提取并保存：
- 拍摄时间（优先 EXIF，缺失时可使用上传时间）
- GPS（经纬度，若存在）
- 分辨率（宽高）
- 拍摄设备相关字段（若存在）：相机型号、光圈、快门、ISO

并生成（可用于检索的）辅助信息：
- 自动时间标签：`时间/{年}`（`tag_type='auto'`）
- 自动地点标签（可选）：若配置 `AMAP_API_KEY` 且逆地理返回 `province + city`，则生成：
  - `地点/{省}`、`地点/{省}/{地级市}`（均为 `tag_type='auto'`，严格使用 AMap 的 `city` 字段）

### 3.4 自定义标签（基本功能 4）
- 支持为图片添加/删除标签
- 标签为路径式字符串（例如 `人物/家人`、`地点/浙江省/杭州市`）
- 同一图片不应出现重复标签（由关联表唯一约束与代码逻辑共同保证）

### 3.5 缩略图生成（基本功能 5）
上传与编辑保存时自动生成两种缩略图（用于列表与详情预览）：
- small：约 200px 边长（列表用）
- medium：约 800px 边长（详情用）

### 3.6 图片信息入库（基本功能 6）
- 图片基础信息保存在 `image`
- EXIF/元信息保存在 `image_metadata`
- 标签在 `tag` 与 `image_tag` 中维护
- 轮播列表在 `carousel_item` 中维护

### 3.7 条件查询（基本功能 7）
提供条件搜索，支持组合筛选（按用户隔离），典型条件包括：
- 标签（多选）
- 文件名关键词（模糊）
- 时间（上传/拍摄时间范围，视 UI 与解析条件而定）

### 3.8 友好展示（轮播）（基本功能 8）
- 用户可在图库中通过缩略图卡片上的“★”按钮将图片加入轮播列表
- 轮播列表最多 20 张（超限提示）
- 轮播页面/组件可自动播放（具体交互以 UI 为准）

### 3.9 基础编辑（基本功能 9）
支持对选定图片进行编辑并保存新副本：
- 裁剪（CropperJS）
- 旋转（每次 90°）
- 调色：亮度/对比度/饱和度/色相（Hue）
- 编辑后导出为新图片并上传后端入库，不覆盖原图
- 新副本自动继承原图标签（包含 `custom/ai/auto`）
- 新副本命名策略：`原名(1).ext`、`原名(2).ext`……（避免重复）

### 3.10 删除（基本功能 10）
- 支持删除图片（删除记录与对应文件：原图/缩略图）
- 仅允许删除当前用户的资源

### 3.11 移动端适配（基本功能 11）
- UI 支持响应式布局，可在手机浏览器/微信内置浏览器友好使用
- 关键操作（上传、搜索、详情、编辑、轮播）在移动端可完成

---

## 4. 增强功能

### 4.1 AI 标签（增强功能 1）
- 用户可对单张图片触发 AI 分析并生成 `tag_type='ai'` 的标签
- AI 标签写入数据库，可删除，不影响用户自定义标签
- 外部依赖：`GEMINI_API_KEY`（缺失或网络不可用时需提示）

### 4.2 大模型对话检索（增强功能 2）
当前实现提供“可被大模型调用”的自然语言检索能力：
- `POST /api/images/nl-search`：用户自然语言 → Gemini 解析 → 结构化条件 → 统一搜索链路

---

## 5. 数据与接口要求

### 5.1 数据库脚本
- MySQL 初始化：`docker/mysql/init.sql`
- 后端启动自检：`backend/src/db/ensureSchema.js`（用于创建缺失表/补齐部分字段能力）

### 5.2 API 文档
- OpenAPI：`backend/src/openapi.yaml`（启动后通过 Swagger UI 查看）

### 5.3 关键环境变量
见仓库根目录 `.env.example`，关键项包括：
- `DB_*`：数据库连接
- `JWT_SECRET` / `JWT_EXPIRES_IN`
- `UPLOADS_DIR`
- `GEMINI_API_KEY` / `GEMINI_*`
- `AMAP_API_KEY`

---

## 6. 非功能性需求
- 安全：密码 bcrypt 哈希；JWT 鉴权；按 `user_id` 隔离数据；避免返回内部错误细节
- 稳定性：Gemini 调用设置超时（避免前端长时间卡死）；外部服务失败可降级（AI/AMap 可选）
- 兼容性：PC 与移动端浏览器可用；上传文件名支持中文（对 multipart 历史编码问题做了兼容处理）
- 可部署性：Docker Compose 一键启动；MySQL 与上传目录使用 volume 持久化


